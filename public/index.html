
<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>Test dragging</title>
	<script src="https://www.gstatic.com/firebasejs/4.1.2/firebase.js"></script>
	<script type="text/javascript" src="js/phaser.min.js"></script>
	<script type="text/javascript" src="button.js"></script>
	<script type="text/javascript" src="atom.js"></script>
	<script type="text/javascript" src="trial.js"></script>
	<script type="text/javascript" src="delayText.js"></script>
	<script src="questions.txt"></script>
	<link rel="stylesheet" href="layout.css">
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>
	<div id= "formQuest" class = "questionnaire">
		<form class = "formcontent">
			<table style="width:100%"  class="main">
				<tr width = "55%">
				<td>
					<b>Thank you for participating! I would like you to answer the following questions: </b><br> <br>
				</td>
				<td>
				</td>
				</tr>
				<tr>
					<td width = "50%">
			  		How old are you?
					</td>
					<td width = "50%">
						<input type="text" id="age" name="fname"><br> <br>
					</td>
				</tr>
				<tr>
					<td width = "50%">
					What are you currently studying or what is your highest educational background?
					</td>
					<td width = "50%">
						 <input type="text" id="study" name="fname"><br> <br>
					</td>
				</tr>
				<tr>
					<td>
					How many years did you take chemistry?
					</td>
					<td>
						 <input type="text" id="exp" name="fname"><br> <br>
					</td>
				</tr>
				<tr>
					<td>
						The order of the questions was good.
					</td>
					<td>
						<input type="radio" name="choiceGood" value="1"> 1
						<input type="radio" name="choiceGood" value="2"> 2
						<input type="radio" name="choiceGood" value="3"> 3
						<input type="radio" name="choiceGood" value="4"> 4
						<input type="radio" name="choiceGood" value="5"> 5<br> <br>
					</td>
				</tr>
				<tr>
					<td>
						The hints that I received were helpful.
					</td>
					<td>
						<input type="radio" name="choiceHint" value="1"> 1
						<input type="radio" name="choiceHint" value="2"> 2
						<input type="radio" name="choiceHint" value="3"> 3
						<input type="radio" name="choiceHint" value="4"> 4
						<input type="radio" name="choiceHint" value="5"> 5<br> <br>
				</td>
				</tr>
				<tr>
					<td>
						I liked the game.
					</td>
					<td>
						<input type="radio" name="choiceLike" value="1"> 1
						<input type="radio" name="choiceLike" value="2"> 2
						<input type="radio" name="choiceLike" value="3"> 3
						<input type="radio" name="choiceLike" value="4"> 4
						<input type="radio" name="choiceLike" value="5"> 5<br> <br>
					</td>
				</tr>
				<tr>
					<td>
						I think I have learnt from the game.
					</td>
					<td>
						<input type="radio" name="choiceLearn" value="1"> 1
						<input type="radio" name="choiceLearn" value="2"> 2
						<input type="radio" name="choiceLearn" value="3"> 3
						<input type="radio" name="choiceLearn" value="4"> 4
						<input type="radio" name="choiceLearn" value="5"> 5<br> <br>
					</td>
				</tr>
				<tr>
					<td>
						The game was too easy.
					</td>
					<td>
						<input type="radio" name="choiceEasy" value="1"> 1
						<input type="radio" name="choiceEasy" value="2"> 2
						<input type="radio" name="choiceEasy" value="3"> 3
						<input type="radio" name="choiceEasy" value="4"> 4
						<input type="radio" name="choiceEasy" value="5"> 5<br> <br>
					</td>
				</tr>
				<tr>
					<td>
						The game was unclear.
					</td>
					<td>
						<input type="radio" name="choiceClear" value="1"> 1
						<input type="radio" name="choiceClear" value="2"> 2
						<input type="radio" name="choiceClear" value="3"> 3
						<input type="radio" name="choiceClear" value="4"> 4
						<input type="radio" name="choiceClear" value="5"> 5<br> <br>
					</td>
				</tr>
				<tr>
					<td>
						Do you have any comments on the game?
					</td>
					<td>
						<input type="text" id="comment" name="fname"><br> <br>
					</td>
				</tr>
			</table> <br>
	  	<input type="button" onclick="submitResults();" value="Submit">
			</form>
		</div>
	</div>
	<div id = "result" class = "resultSaved">
		<p style = "font: 20px Calibri"> Your results have been saved! Thank you for participating! :) </p>
	</div>

	<div id="startG" class= "firstpopup">
		<p style= "font: bold 20px Calibri"> Welcome to the laboratory! </p>
		<p id = "startTextofGame" style = "font: 14px Calibri"></p>
		<input type= "image" src = "images/start.png" id= "startButton" onclick ="startG()">
	</div>
	<div id="wrongAnswer" class = "popup" >
		<div class = "popup-content">
			<p id = "textAnswer" style ="font: 12px Verdana" ></p>
		</div	>
	</div>

	<div id= "gamedone" class = "popup">
		<div class = "popup-content">
			<p id = "finishText" style="font: 12px Verdana;"></p>
		</div>
	</div>
	<div id= "totalScore" class= "lastpopup">
		<div class = "las-content">
			<p id = "score" style="font: 12px verdana;"></p>
		</div>
	</div>

	<div class = "progressText">
		<div class = "textProgresscontent">
			<p id="textprogress" style="font: bold 18px times new roman; color: green;"> Current Salary</p>
		</div>
	</div>

	<div class = "atomButtons">
		<div class = "textProgresscontent">
			<p id="atomtextprogress" style="font: bold 18px times new roman; color: green;"> Atom creators</p>
		</div>
	</div>

	<div class = "progress">
		<div id="myProgress">
	  	<div id="myBar"></div>
		</div>
	</div>

	<div class = "amountSalary">
		<div class = "SalaryContent">
			<p id="salarytext" style="font: bold 25px times new roman; color: green;"></p>
		</div>
	</div>

	<div id= "missionTextPopup" class = "missionPopup">
		<div class = "mission-content">
			<p id = "missionText"></p>
		</div>
	</div>

<script type="text/javascript">
  // Initialize Firebase // it is not save!! Maybe make save
var config = {
  apiKey: "AIzaSyDFK1lTVkm5Gl_ENEn5o2YXzWvEzLcSYMw",
  authDomain: "chemistrygame-eca18.firebaseapp.com",
  databaseURL: "https://chemistrygame-eca18.firebaseio.com",
  projectId: "chemistrygame-eca18",
  storageBucket: "chemistrygame-eca18.appspot.com",
  messagingSenderId: "2394046920"
};
firebase.initializeApp(config);
var database = firebase.database();

var game = new Phaser.Game(800, 600, Phaser.AUTO, 'phaser-example', { preload: preload, create: create, update: update, render: render});

var popup = document.getElementById('wrongAnswer');
var finish = document.getElementById('gamedone');
var last = document.getElementById('totalScore');
var firstpopup = document.getElementById('startG');
var missionpopup = document.getElementById('missionTextPopup');
var questionnaire = document.getElementById('formQuest');
var bar = document.getElementById("myBar");

bar.style.height = "85%";


var currentQuestion = new Trial(game);
var id = 0;
var height = 90;

var listOfQuestions = [];
var priorityQueueQuestions = [];
var text = [];
var feedbackText = [];
var buttonsList = [];
var index = 0;

var buttons = ['HButton', 'CButton', 'OButton', 'QButton', 'FButton', 'IButton', 'ZButton'];
var positionY = [75, 125, 175, 225, 275, 325, 375];
var atomValues = ['H', 'C', 'O', 'Q', 'F', 'I', 'Z'];
var covalences = [1,4,2,1,1,1,1,1];
var gameIsFinished = false;
var randomStrategy = false;
var giveHints = false;
var boolEvaluateAnswer = false;
var rand = Math.round(Math.random() * 10000000);

// https://chemistrygame-eca18.firebaseapp.com/
var floor;
var doneButton;
var deleteButton;
var nextQuestion;
var next;
var totalScore = 15; // van 0 tot 100. 0 is niks 100 is alles.
var startTimeOfPlayer = Date.now();

function preload() {
		game.load.image('CButton', 'images/CAtoomButtonGreen.png');
		game.load.image('OButton', 'images/OAtoomButtonGreen.png');
		game.load.image('HButton', 'images/HAtoomButtonGreen.png');
		game.load.image("FButton", 'images/FAtoomButtonGreen.png');
		game.load.image("QButton", 'images/BrAtoomButtonGreen.png');
		game.load.image("IButton", 'images/IAtoomButtonGreen.png');
		game.load.image("ZButton", "images/ClAtoomButtonGreen.png");
		game.load.image("Z", "images/ClAtomCircle.png");
		game.load.image('delete', 'images/garbage.png');
		game.load.image('C', 'images/CAtomCircle.png');
		game.load.image('H', 'images/HAtomCircle.png');
		game.load.image('O', 'images/OAtomCircle.png');
		game.load.image('I', 'images/IAtomCircle.png');
		game.load.image('Q', 'images/BrAtomCircle.png');
		game.load.image('F', 'images/FAtomCircle.png');
		game.load.image('done', 'images/doneButton2.png');
		game.load.image('tryAgain', 'images/tryAgain.png');
		game.load.image('nextQuestion', 'images/nextAssignment.png');
		game.load.image('next', 'images/next2.PNG');
		game.load.image('start', 'images/start.png');
		game.load.image('finish', 'images/finish.png');
		game.load.text('questions', 'questions.txt');
}

function create(){
	var x = document.getElementById("formQuest");
	console.log(x);
	determineStrategy();
	setStrategyDB(rand);

	var graphics1 = game.add.graphics(0, 0);
	var graphics2 = game.add.graphics(0, 0);
	var whiterect = game.add.graphics(0, 0);

	graphics1.beginFill(0xffdd99);
	graphics2.beginFill(0xAAAAAA);
	whiterect.beginFill(0xe6f2ff);
	graphics1.drawRect(10, 10, 80, 480); //3
	graphics1.drawRect(10, 500, 80, 90); //4
	graphics1.drawRect(100, 500, 575, 90); //5
	graphics1.drawRect(685, 500, 105, 90); //6
	graphics1.drawRect(685, 10, 105, 480); //7
	whiterect.drawRect(100,10, 575, 480); //2

	updateSalary();
	makeStartPopup();
	readQuestion();
	makePriorityQueue();
	currentQuestion = decideQuestion();

	if(currentQuestion != null){
		currentQuestion.showQuestion();
	}
	game.stage.backgroundColor = "#DBB782";
	doneButton = game.add.button(675, 505, 'done', evaluateAnswer, this);
	nextQuestion = game.add.button(695, 515, 'nextQuestion', showNextQuestion, this);
	deleteButton = game.add.image(9, 500, 'delete');
	next = game.add.button(675, 500, 'next', showForm, this);

	deleteButton.scale.setTo(0.4, 0.4);
	nextQuestion.scale.setTo(0.4, 0.4);
	doneButton.visible = false;
	deleteButton.visible = false;
	nextQuestion.visible = false;
	next.visible = false;

	for(var i=0; i<buttonsList.length; i++){
		buttonsList[i].visible = false;
	}
}

function determineStrategy(){
	var rand = Math.random();
	if(rand <= 0.5){
		randomStrategy = false;
	}
	else{
		randomStrategy = true;
	}
}

function showForm(){
	last.style.display = 'none';
	questionnaire.style.display = 'block';
	deleteSprites();
	currentQuestion.removeButtons();
	missionpopup.style.display = 'none';
	next.visible = false;
	deleteButton.visible = false;
	finish.style.display = 'none';
	var progress = document.getElementById("atomtextprogress");
	progress.style.display = 'none';
}

function submitResults(){
	questionnaire.style.display = 'none';
	var bar = document.getElementById("myProgress");
	var currentSalary = document.getElementById("textprogress");
	var salary = document.getElementById("salarytext");
	currentSalary.style.display = 'none';
	salary.style.display = 'none';
	bar.style.display = 'none';

	showThanksPop();

	console.log("hallo");
	var age = document.getElementById("age").value;
	var study = document.getElementById("study").value;
	var order = document.getElementsByName("choiceGood");
	var hints = document.getElementsByName("choiceHint");
	var like = document.getElementsByName("choiceLike");
	var learn = document.getElementsByName("choiceLearn");
	var easy = document.getElementsByName("choiceEasy");
	var clear = document.getElementsByName("choiceClear");
	var exp = document.getElementById("exp").value;
	var comment = document.getElementById("comment").value;

	var orderNb = returnChoice(order);
	var hintsNb = returnChoice(hints);
	var likeNb = returnChoice(like);
	var learnNb = returnChoice(learn);
	var easyNb = returnChoice(easy);
	var clearNb = returnChoice(clear);

	saveQuestionnaireData(rand, age, study, exp, orderNb, hintsNb, likeNb, learnNb, easyNb, clearNb, comment)

}

function showThanksPop(){
	var result = document.getElementById("result");
	result.style.display = 'block';
}

function returnChoice(choice){
	for(var i=0; i < choice.length; i++){
		if(choice[i].checked){
			return choice[i].value;
		}
	}
	return 0;
}

function setStrategyDB(userId){
	firebase.database().ref('users/' + startTimeOfPlayer + "_ID_" + userId + '/randomStrategy').set(randomStrategy);
}

//firebase.database().ref('users/' + Date.now() + "_ID_"+ userId + '_tr' + trial).set(
// make form in html for the docs and make new table where you save those findings with the same userId.
// ref('summary/' +vid)
function writeUserData(userId, trial, score, currentM, targetM, time) {
  firebase.database().ref('users/' + startTimeOfPlayer + "_ID_" + userId + '/trials/' + trial).set({
    score: score,
		response: currentM,
		time: time,
		target: targetM,
		moleculeName : currentQuestion.moleculeName,
    });
}

function saveQuestionnaireData(userId, age, study, exp, order, hint, like, learn, easy, clear, comment){
	firebase.database().ref('users/' + startTimeOfPlayer + "_ID_" + userId + '/questionnaire/').set({
		age: age,
		study: study,
		exp: exp,
		order: order,
		hint: hint,
		like:like,
		learn: learn,
		easy: easy,
		clear: clear,
		comment: comment,
	});
}

function makeButtons(){
	for(var i=0; i< buttons.length; i++){
		var buttonTest = new button(buttons[i], atomValues[i], 30, positionY[i]);
	}
}

function decideQuestion(){
	if(randomStrategy){
		return pickRandomQuestion();
	}
	else{
		if(currentQuestion.molecule.length == 0 && !currentQuestion.alreadyAdded){
			priorityQueueQuestions[0].isAsked = true;
			changeCovalence(priorityQueueQuestions[0]);
			priorityQueueQuestions[0].determineCovalence();
			return priorityQueueQuestions[0];
		}
		return decideAdaptively();
	}
}

function render () {
    game.debug.geom(floor,'#ffffff');
}

function makeStartPopup(){
	var startTextofGame = document.getElementById('startTextofGame');
	if(!randomStrategy){
	startTextofGame.innerText =
		"When you click on Start you are asked to complete some important assignments! \n" +
		"Try to complete as many assignments as you can and become rich (and save the world)!\n \n The bar on the right indicates how much money you are currently earning. " +
		"The panel on the left will show some elements that you could use to make molecules. If you click on one of these elements, one atom will appear on the screen. " +
		"You will be able to drag these atoms around and connect them together. They will become grey when connected. \n" +
		"If you are in need, your assistant will show up and help you! \n \n"  +
		"Your assistant can help you in various ways. When atoms suddenly become dark green or red, it means that your assistant is helping you with the connections. " +
		"Red means that the atom should be connected with less other atoms, dark green means that the atom is connected with the correct amount of atoms and light green means that an atom is connected and could be connected to more atoms. " +
		"Other types of help will become clear in the game itself! \n \n" +
		"We need you! Do not disappoint us! Good luck."
	}
	else{
		startTextofGame.innerText =
		"When you click on Start you are asked to complete some important assignments! \n" +
		"Try to complete as many assignments as you can and become rich (and save the world)!\n \n The bar on the right indicates how much money you are currently earning. " +
		"The panel on the left will show some elements that you could use to make molecules. If you click on one of these elements, one atom will appear on the screen. " +
		"You will be able to drag these atoms around and connect them together. They will become grey when connected. \n \n " +
		"We need you! Do not disappoint us! Good luck."
	}
}

function startG(){
	firstpopup.style.display = 'none';
	for(var i=0; i<buttonsList.length; i++){
		buttonsList[i].visible = true;
	}
	deleteButton.visible = true;
	doneButton.visible = true;
}

function determineOveralDifficulty(){
	var sum = 0;
	for(var i=0; i < listOfQuestions.length; i++){
		sum = sum + listOfQuestions[i].difficulty;
	}
	return sum;
}

function updateBar() {
	var SPEED = 1;
	var MINIMUM_EPSILON = 1;

	var elem = document.getElementById("myBar");
	var goalHeight = 100 - this.totalScore;
	var id = setInterval(frame, 20);

	function frame() {
		var currentHeight = parseInt(elem.style.height);
		var epsilon = goalHeight - currentHeight;
		if (Math.abs(epsilon) < MINIMUM_EPSILON)
			clearInterval(id);
		var newHeight = currentHeight + SPEED * Math.sign(epsilon)
		elem.style.height = newHeight + '%';
	}
}

function updateBarColor(){
	var elem = document.getElementById("myProgress");
	if(totalScore <= 15){
		elem.style.backgroundColor = "red";
	}
	else if(totalScore <= 30 && totalScore > 15){
		elem.style.backgroundColor = "orange";
	}
	else if(totalScore <= 50 && totalScore > 30){
		elem.style.backgroundColor = "yellow";
	}
	else if(totalScore <= 65 && totalScore > 50){
		elem.style.backgroundColor = "#ccff66";
	}
	else{
		elem.style.backgroundColor = "#669900";
	}
}

function updateSalary(){
	var salarytext = document.getElementById('salarytext');
	var roundScore =  Math.round(60 *totalScore);
	if(roundScore == 1){
		salarytext.innerText = "$ " + 1;
	}
	else{
		salarytext.innerText = "$ " + roundScore;
	}
}

function deleteAtom(){
	if(this.sprite.x < 90 && this.sprite.x > 10 && this.sprite.y > 500 && this.sprite.y < 590){
		this.sprite.destroy();
		removeAtom(this);
	}
}

function removeAtom(atom){
	for(var i=0; i < currentQuestion.currentMolecule.length; i++){
		if(currentQuestion.currentMolecule[i].id == atom.id){
			currentQuestion.currentMolecule.splice(i, 1);
		}
	}
}

function makePriorityQueue(){
	var priority = [];
	for(var i=0; i<listOfQuestions.length; i++){
		priority.push(listOfQuestions[i].difficulty);
	}
	priority = priority.sort(function(a,b){
		return (+a) - (+b);
	});
	for(var i=0; i<priority.length; i++){
		for(var j=0; j<listOfQuestions.length; j++){
			if(priority[i] == listOfQuestions[j].difficulty && !priorityQueueQuestions.includes(listOfQuestions[j])){
				this.priorityQueueQuestions.push(listOfQuestions[j]);
			}
		}
	}
}

function pickRandomQuestion(){
	if(!allQuestionsAreAsked()){
		if(currentQuestion.repeat > 0 && currentQuestion.molecule.length != 0){
			currentQuestion.repeat -= 1;
			return currentQuestion;
		}
		else{
			var x = Math.floor(Math.random() * (priorityQueueQuestions.length - 0));
			while(priorityQueueQuestions[x].isAsked == true || priorityQueueQuestions[x].repeat != -1){
				x = Math.floor(Math.random() * (priorityQueueQuestions.length - 0));
			}
			priorityQueueQuestions[x].isAsked = true;
			return priorityQueueQuestions[x];
		}
	}
	else{
		console.log("Nu gaan we stoppen");
		showLastPopup();
	}
}

function decideAdaptively(){
	decideOrderQuestions();
	console.log(priorityQueueQuestions);
	for(var i=0; i< priorityQueueQuestions.length; i++){
		if(priorityQueueQuestions[i].isAsked == false || priorityQueueQuestions[i].repeat >= 1){
			priorityQueueQuestions[i].isAsked = true;
			if(priorityQueueQuestions[i].repeat > 0){
				priorityQueueQuestions[i].repeat -= 1;
			}
			return priorityQueueQuestions[i];
		}
	}
}

function decideOrderQuestions(){
	for(var i=0; i < priorityQueueQuestions.length; i++){
		console.log(i);
		console.log(priorityQueueQuestions[i]);
		if(priorityQueueQuestions[i] == currentQuestion && currentQuestion.score == -1){
			var position = Math.min(priorityQueueQuestions.length, i+3);
			console.log(position);
			priorityQueueQuestions.splice(position, 0, priorityQueueQuestions[i]);
			priorityQueueQuestions.splice(i, 1);
			return;
		}
		else if(priorityQueueQuestions[i] == currentQuestion && currentQuestion.score == -0.8 || currentQuestion.score == -0.6){
			var position = Math.min(priorityQueueQuestions.length, i+4);
			console.log(position);
			priorityQueueQuestions.splice(position, 0, priorityQueueQuestions[i]);
			priorityQueueQuestions.splice(i, 1);
			return;

		}
		else if(priorityQueueQuestions[i] == currentQuestion &&  ((currentQuestion.score == -0.5) || (currentQuestion.score == 0.4) || (currentQuestion.score == -0.2))){
			var position = Math.min(priorityQueueQuestions.length, i+5);
			console.log(position);
			priorityQueueQuestions.splice(position, 0, priorityQueueQuestions[i]);
			priorityQueueQuestions.splice(i, 1);
			return;
		}
		else if(priorityQueueQuestions[i] == currentQuestion && currentQuestion.score == 0){
			var position = Math.min(priorityQueueQuestions.length, i+6);
			console.log(position);
			priorityQueueQuestions.splice(position, 0, priorityQueueQuestions[i]);
			priorityQueueQuestions.splice(i, 1);
			return;
		}
	 }
}

function determineText(){
	if(totalScore < 55){
		return 'Your salary is not that high, perhaps you should take a second job.';
	}
	else if(totalScore < 70 && totalScore > 55){
		return 'Great job!';
	}
	else{
		return 'Excellent. You\'ve become rich!';
	}
}

// hier nog even naar kijken!
function showTotalScore(){
	deleteSprites();
	next.visible = false;
	last.style.display = 'block';
	var lastPop = document.getElementById('score');
	finish.style.display = 'none';
	var endText = determineText();
	lastPop.innerText = "Your final salary is " + Math.floor(60* totalScore) + " euros. " + endText + "\n \n You are almost done with my experiment! Click on next to fill in the questionnaire.";
}

function showLastPopup(text){
	showTotalScore();
	var gameDone = document.getElementById('finishText');
	if(text.indexOf('incorrect') > -1){
		gameDone.style.color = 'red';
	}
	gameDone.innerText = text;
	finish.style.display = 'block';
	next.visible = true;
}

function restartGame(){
	for(var i=0; i < priorityQueueQuestions.length; i++){
		priorityQueueQuestions[i].isAsked = false;
		priorityQueueQuestions[i].repeat = -1;
		priorityQueueQuestions[i].score = 0;
	}
	if(!randomStrategy){
		currentQuestion.finishGame();
	}
	totalScore = 10;
	updateBar();
	updateSalary();
	showNextQuestion();
}

function finishGame(){
	deleteSprites();
	if(text != undefined){
		game.world.remove(text);
		currentQuestion.finishGame();
	}
	gameIsFinished = true;
}

function getScore(){
	var sum = 0;
	for(var i=0; i < priorityQueueQuestions.length; i++){
			sum += priorityQueueQuestions[i].score;
	}
	return sum/priorityQueueQuestions.length * 10;
}

function allQuestionsAreAsked(){
	for(var i=0; i<priorityQueueQuestions.length; i++){
		if(priorityQueueQuestions[i].isAsked == false || priorityQueueQuestions[i].repeat > 0){
			console.log("repeat: " + priorityQueueQuestions[i].repeat);
			return false;
		}
		console.log("repeat: " + priorityQueueQuestions[i].moleculeName, priorityQueueQuestions[i].repeat);
	}
	return true;
}

function makeTrial(trial, index, textsQuestion){
	for(var i= index; i< textsQuestion.length; i++){
		if(textsQuestion[i].indexOf('Question') > -1){
			var newQuestion = textsQuestion[i].split(/~/);
			trial.currentQuestionText = newQuestion[1];
		}
		else if(textsQuestion[i].indexOf('Name') > -1){
			var newQuestion = textsQuestion[i].split(/~/);
			trial.moleculeName = newQuestion[1];
		}
		else if(textsQuestion[i].indexOf('Mole') > -1){
			var newQuestion = textsQuestion[i].split(/~/);
			var atomsOfMolecule = newQuestion[1];
			for(var j=0; j < atomsOfMolecule.length; j++){
				var atom = new Atom(atomsOfMolecule[j], false, id+j, game);
				trial.molecule.push(atom);
				//trial.copyMolecule.push(atom);
			}
		}
		else if(textsQuestion[i].indexOf('Familiarity') > -1){
			var familiarity = textsQuestion[i].split(/~/);
			trial.familiarity = familiarity[1];
		}
		else if(textsQuestion[i].indexOf("Binding") > -1){
			for(var m=i+1; m < textsQuestion[i+1].length+i+1; m++){
				for(var k=0; k< textsQuestion[i+1].length; k++){
					var value = textsQuestion[m];
					if(value[k] == 1){
						trial.molecule[k].addConnection(trial.molecule[m-(i+1)]);
					}
				}
			}
			this.listOfQuestions.push(trial);
			trial.determineDifficulty();
			return;
		}
	}
	return;
}

function readQuestion(){
  var textQuestion = game.cache.getText('questions');
  textsQuestion = textQuestion.split('\n');
	for(var i=0; i< textsQuestion.length; i++){
		if(textsQuestion[i] == ""){
			makeTrial(new Trial(game), i+1, textsQuestion);
		}
	}
}

function showNextQuestion(){
	var date = Date.now();
	console.log(date);
	boolEvaluateAnswer = false;
	deleteSprites();
	nextQuestion.visible = false;
	doneButton.visible = true;
	var textAnswer = document.getElementById('textAnswer');
	textAnswer.style.color = "black";
	popup.style.display = 'none';
	missionpopup.style.display = 'block';
	currentQuestion = decideQuestion(priorityQueueQuestions);
	if(currentQuestion != null){
		changeCovalence(currentQuestion);
		currentQuestion.determineCovalence();
		currentQuestion.showQuestion();
	}
	else{
		return;
	}
}

function changeCovalence(question){
	if(question.moleculeName == 'carbondioxide'){
		covalences = [1,2,1,1,1,1,1,1];;
	}
	else if(question.moleculeName == "oxygen"){
		covalences = [1,4,1,1,1,1,1,1];;
	}
	else{
		covalences = [1,4,2,1,1,1,1,1];
	}
}

function makeCopyMolecule(molecule){
	var copy = []
	for(var i=0; i < molecule.length; i++){
		copy.push(molecule[i]);
	}
	return copy;
}

// neighbours veranderen.
function changeMolecule(molecule){
	var copyOf = makeCopyMolecule(molecule);
	var newMol = [];
	for(var i=0; i< copyOf.length; i++){
		newMol.push(new Atom(copyOf[i].value, false, copyOf[i].id, game));
		newMol[i].covalence = copyOf[i].covalence;
		for(var j=0; j < copyOf[i].neighbour.length; j++){
			newMol[i].neighbour.push(copyOf[i].neighbour[j].id);
		}
	}
	console.log(newMol);
	return newMol;
}

function getFirebaseAtom(atom) {
	var neighbours = [];
	for(var i=0; i < atom.neighbour.length; i++){
		neighbours.push(atom.neighbour[i].id)
	}
	return {"type": atom.value, "id": atom.id, "neighbours": neighbours}
}

function getFirebaseMolecule(molecule){
	var atoms = [];
	for(var i=0; i < molecule.length; i++){
		atoms.push(getFirebaseAtom(molecule[i]))
	}
	return atoms;
}


function evaluateAnswer(){
	currentQuestion.endTime = Date.now();
	var timeNeeded = currentQuestion.determineTime();

	var currentM = getFirebaseMolecule(currentQuestion.currentMolecule);
	var targetM = getFirebaseMolecule(currentQuestion.molecule);

	currentQuestion.makeUndraggable();
	boolEvaluateAnswer = true;
	var tooMany = false;
	var rightAmount = currentQuestion.checkAmountOfAtoms();
	var rightUnique = currentQuestion.checkUniqueAtoms();
	var someRightUnique = currentQuestion.checkSomeUnique();
	var rightType = currentQuestion.checkAmountOfTypeOfAtoms();
	var rightConnections = currentQuestion.checkConnections();

	if(!rightAmount){
		var amountMolecule = currentQuestion.molecule.length;
		var amountCurrent = currentQuestion.currentMolecule.length;
		var getal = amountMolecule - amountCurrent;
		if(getal < 0){
			tooMany = true;
		}
		else{
			tooMany = false;
		}
	}
	determineScore(rightType, rightConnections, rightAmount, rightUnique, someRightUnique, tooMany);
	writeUserData(rand,  index, currentQuestion.score, currentM, targetM, timeNeeded);
	index+=1;
}

function determineScore(rightType, rightConnections, rightAmount, rightUnique, someRightUnique, tooMany){
	if(!gameIsFinished){
		if(rightType && rightConnections && rightAmount && rightUnique){
			currentQuestion.repeat = 0;
			setProgress('Great Job!', 1, 'black');
			return;
		}
		else if(rightType && !rightConnections && rightAmount && rightUnique){
			setProgress('Almost correct! You do not have the right connections between atoms.', 0, 'red');
			if(!randomStrategy){
				currentQuestion.hintConnections = true;
				currentQuestion.helpText = "Your assistant is going to help you with the connections."
			}
		}
		else if(!rightAmount && rightConnections){
			if(tooMany){
				setProgress('Your answer is incorrect. You have too many atoms, but you are almost there!', -0.2, 'red');
			}
			else{
				setProgress('Your answer is incorrect. You need to use more atoms, but you are almost there!', -0.2, 'red');
			}
			if(!rightUnique && !randomStrategy){
				currentQuestion.uniqueButtons = true;
			}
		}
		else if(!rightType && rightConnections && rightUnique){
			setProgress('Your answer is incorrect. You have the right connections but you are still missing some atoms.', -0.4, 'red');
		}
		else if(!rightAmount && !rightUnique){
			if(currentQuestion.currentMolecule.length != 0){
				if(someRightUnique){
					if(tooMany){
						setProgress('Your answer is incorrect. You have too many atoms, however some of these element have the correct type.', -1, 'red');
					}
					else{
						setProgress('Your answer is incorrect. You have too few atoms, however some of these element have the correct type.', -1, 'red');
					}
				}
				else{
					setProgress('Your answer is incorrect. You do not have the right amount of atoms. You should also consider different elements.', -1, 'red');
				}
			}
			else{
				setProgress('Your answer is incorrect. Please try next time! Nothing ventured, nothing gained.', -1, 'red');
			}
			if(!randomStrategy){
				currentQuestion.uniqueButtons = true;
				currentQuestion.helpNumber = true;
				currentQuestion.helpText = "Your assistant thinks you need to use these elements. You are also not able to make more elements than necessary.";
			}
		}
		else if(rightUnique && rightAmount){
			setProgress('Your answer is incorrect. You do use the right types of atoms. You, however, do not have the right amount of each element.', -0.5, 'red');
		}
		else if(rightUnique){
			if(tooMany){
				setProgress('Your answer is incorrect. You do use the right types of atoms, but you have too many of them.', -0.6, 'red');
			}
			else{
				setProgress('Your answer is incorrect. You do use the right types of atoms, but you are still missing atoms.', -0.6, 'red');
			}
			if(!randomStrategy){
				currentQuestion.helpNumber = true;
				currentQuestion.helpText = "Your assistant is going to help you. You are not able to make more elements than necessary."
			}
		}
		else if(rightAmount){
			if(someRightUnique){
				setProgress('Your answer is incorrect. You have the right amount of atoms, but you do not use all the right element types.', -0.8, 'red');
			}
			else{
				setProgress('Your answer is incorrect. The amount of atoms needed for this assignment is correct, however you should use different elements.', -0.8, 'red');
			}
			if(!randomStrategy){
				currentQuestion.uniqueButtons = true;
				currentQuestion.helpText = "Your assistant thinks you need to use these elements.";
			}
		}
		if(currentQuestion.repeat == -1){
			currentQuestion.repeat = 3;
		}
	}
}

function setProgress(feedback, score, colour){
	totalScore += convertScoreChange(score);
	totalScore = Math.max(0,totalScore);
	updateBar();
	updateBarColor();
	updateSalary();
	currentQuestion.score = score;

	if(allQuestionsAreAsked() && (currentQuestion.score == 1  || currentQuestion.repeat == 0)){
		console.log("hallo");
		doneButton.visible = false;
		nextQuestion.visible = false;
		popup.style.display = 'none';
		missionpopup.style.display = 'none';
		showLastPopup(feedback);
	}
	else{
		console.log("Nu gaan we stoppen");
		var textAnswer = document.getElementById('textAnswer');
		textAnswer.style.color = colour;
		textAnswer.innerText =  feedback;
		doneButton.visible = false;
		nextQuestion.visible = true;
		popup.style.display = 'block';
		missionpopup.style.display = 'none';
	}
}

function deleteSprites(){
	for(var i=0; i<currentQuestion.currentMolecule.length; i++){
		currentQuestion.currentMolecule[i].sprite.destroy();
	}
	currentQuestion.currentMolecule = [];
}

function convertScoreChange(answerScore) {
	var totalDifficulty = determineOveralDifficulty();
	return answerScore * 85 * currentQuestion.difficulty / totalDifficulty;
}

// This function counts the number of atoms with a specific value in a molecule
function countNumberOfAtoms(SpecMolecule, valueOfSpecificAtom){
	var count = 0;
	for(var i=0; i< SpecMolecule.length; i++){
		if(SpecMolecule[i].value == valueOfSpecificAtom){
			count = count + 1;
		}
	}
	return count;
}
//Object button
function button(buttonName, element, X, Y){
  this.element = element;
  this.buttonName = buttonName;

  this.actionOnClick = function(){
    if(currentQuestion.helpNumber){
			if(countNumberOfAtoms(currentQuestion.currentMolecule, element) != countNumberOfAtoms(currentQuestion.molecule, element) && !gameIsFinished && !boolEvaluateAnswer){
	  		var atomNew = new Atom(element, true, id, game);
				atomNew.covalence = atomNew.determineCovalence();
	  		currentQuestion.currentMolecule.push(atomNew);
				id = id+1;
	  	}
		}
		else{
			var atomNew = new Atom(element, true, id, game);
			atomNew.covalence = atomNew.determineCovalence();
			currentQuestion.currentMolecule.push(atomNew);
			id = id+1;
		}
  }
  var button = game.add.button(X, Y, buttonName, this.actionOnClick, this);
	game.world.bringToTop(button);
	buttonsList.push(button);
  button.scale.setTo(0.3, 0.3);
}

function atomsAreSnapped(atomA, atomB){
	for(var i=0; i< atomA.neighbour.length; i++){
		if(atomA.neighbour[i].id == atomB.id){
			return true;
		}
	}
	return false;
}

// this functions adds atoms that are close together
function snap(currentMolecule){
	for(var i=0; i< currentMolecule.length; i++){
		for(var j=0; j< currentMolecule.length; j++){
			if(i != j){
				var distance = game.physics.arcade.distanceBetween(currentMolecule[i].sprite, currentMolecule[j].sprite);
				if(distance < 40){
					currentMolecule[i].addConnection(currentMolecule[j]);
					currentMolecule[i].sprite.input.enableSnap(32, 32, true, true);
					currentMolecule[i].determineTint();
				}
			}
		}
	}
	undoneSnap(currentMolecule);
}

// This function checks whether some atoms have neighbours that need to be 'unsnapped' and unsnaps them.
function undoneSnap(currentMolecule){
	for(var i=0; i< currentMolecule.length; i++){
		var atom = currentMolecule[i]
		for(var j=0; j<currentMolecule[i].neighbour.length; j++){
				var distance = game.physics.arcade.distanceBetween(currentMolecule[i].sprite, currentMolecule[i].neighbour[j].sprite);
				if(distance > 40){
					currentMolecule[i].removeConnection(currentMolecule[i].neighbour[j]);
				}
		}
		if(currentMolecule[i].neighbour.length == 0){
			currentMolecule[i].sprite.input.enableSnap(32, 32, false, true);
		}
		currentMolecule[i].determineTint();
	}
}

// This update function checks whether two molecules are close to each other and then snaps.
function update() {
	if(currentQuestion != null && !gameIsFinished){
		if(currentQuestion.currentMolecule != null){
			snap(currentQuestion.currentMolecule);
		}
	}
}

</script>
</body>
</html>
